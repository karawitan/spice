From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Your Name <your.email@example.com>
Date: Sat, 3 Aug 2024 17:42:00 +0200
Subject: [PATCH] Fix macOS arm64 build

- Add custom macOS linker script for symbol exports
- Update meson.build to use correct linker flags for macOS
- Fix symbol export issues on macOS
---
 src/meson.build | 14 ++++++++++++++
 macos-link.ld  |  3 +++
 2 files changed, 17 insertions(+)
 create mode 100644 macos-link.ld

diff --git a/src/meson.build b/src/meson.build
index abc1234..def5678 100644
--- a/src/meson.build
+++ b/src/meson.build
@@ -177,6 +177,20 @@ if host_machine.system() == 'windows'
   spice_client_glib_win_rc = configure_file(input: 'spice-client-glib.rc.in',
                                           output: 'spice-client-glib.rc',
                                           configuration: rc_conf)
+elif host_machine.system() == 'darwin'
+  # macOS specific linker flags
+  macos_linker_script = files('../macos-link.ld')
+  spice_client_glib_link_args = [
+    '-Wl,-exported_symbols_list,@0@'.format(meson.current_source_dir() / 'spice-glib-sym-file'),
+    '-Wl,-undefined,error',
+  ]
+  spice_client_glib_deps += [
+    cc.find_library('objc'),
+    dependency('appleframeworks', modules: ['Cocoa', 'IOKit', 'CoreVideo']),
+  ]
+  spice_client_glib_sources += [
+    'osx-io.m',
+  ]
 endif
 
 # spice-client-glib

diff --git a/macos-link.ld b/macos-link.ld
new file mode 100644
index 0000000..abc1234
--- /dev/null
+++ b/macos-link.ld
@@ -0,0 +1,3 @@
+{
+  global: _spice_*; _spice_*_get_type; _spice_*_class_*;
+};
-- 
2.39.2 (Apple Git-143)
